import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  addDoc, 
  deleteDoc, 
  onSnapshot, 
  collection, 
  query,
  setLogLevel,
  updateDoc,
  getDoc,
  getDocs,
  setDoc
} from 'firebase/firestore';

// --- NEW: Import Recharts ---
// This is a popular charting library for React.
import { 
  PieChart, 
  Pie, 
  Cell, 
  Tooltip, 
  Legend, 
  ResponsiveContainer, 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid 
} from 'recharts';


// --- Firebase Configuration ---
// User-provided Firebase config.
// NOTE: This will disconnect the app from the platform's database.
const firebaseConfig = {
  apiKey: "AIzaSyA_aKF681FuJdpdkyvdbLRPkQaUKyaRx_8",
  authDomain: "dharmayodha-c0868.firebaseapp.com",
  projectId: "dharmayodha-c0868",
  storageBucket: "dharmayodha-c0868.firebasestorage.app",
  messagingSenderId: "990159164218",
  appId: "1:990159164218:web:d87f67ab43796ea4937603",
  measurementId: "G-P1RW4CNK92"
};

// NOTE: The platform's 'initialAuthToken' is disabled as it's not valid for this custom project.
const initialAuthToken = null;

// --- Helper Icon Components ---
const TrashIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
    <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.54 0c-.27.041-.533.095-.79.157m0 0L5.23 5.337a3.369 3.369 0 0 1-.945-2.268V3c0-.987.89-1.8 2.006-1.8h4.44c1.116 0 2.006.813 2.006 1.8v.069a3.369 3.369 0 0 1-.945 2.268L8.03 5.79m0 0c-.26.062-.52.116-.79.157m6.58-1.5-1.519-.89a1.923 1.923 0 0 0-2.146 0l-1.519.89m13.932 0-1.285.757a1.923 1.923 0 0 1-2.146 0l-1.285-.757m-10.363 0a48.108 48.108 0 0 1 3.478-.397m7.406 0c.27-.041.533.095.79-.157L18.82 5.337a3.369 3.369 0 0 0 .945-2.268V3c0-.987-.89-1.8-2.006-1.8h-4.44c-1.116 0-2.006.813-2.006 1.8v.069a3.369 3.369 0 0 0 .945 2.268l1.716 3.12z" />
  </svg>
);

const PencilIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
    <path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
  </svg>
);

const PlusIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
  </svg>
);

// --- NEW Share Icon (ArrowUpTray) ---
const ShareIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
  </svg>
);

// --- NEW Rupee Icon ---
const CurrencyRupeeIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
    <path strokeLinecap="round" strokeLinejoin="round" d="M15 8.25H9m6 3H9m3 6l-3-3h1.5a3 3 0 1 0 0-6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
  </svg>
);

// --- NEW: Login Screen Component ---
const LoginScreen = ({ pinInput, setPinInput, pinError, onSubmit }) => {
  return (
    <div className="flex items-center justify-center min-h-screen bg-orange-50">
      <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
        <h2 className="text-3xl font-bold text-orange-700 mb-6">
          Dharma Yodha Database
        </h2>
        <p className="text-gray-600 mb-4">Please enter your PIN to continue.</p>
        <form onSubmit={onSubmit} className="space-y-4">
          <FormInput 
            label="PIN"
            name="pin"
            value={pinInput}
            onChange={(e) => setPinInput(e.target.value)}
            type="password" // Use password type to hide input
            required={true}
            placeholder="****"
            autoComplete="off"
            pattern="\d*" // Allow any digits
            title="Please enter your PIN"
          />
          {pinError && (
            <p className="text-red-500 text-sm">{pinError}</p>
          )}
          <button
            type="submit"
            className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors"
          >
            Unlock
          </button>
        </form>
      </div>
    </div>
  );
};


// --- Form Input Components ---
const FormInput = ({ label, name, value, onChange, type = 'text', required = false, placeholder = '', ...props }) => (
  <div>
    <label htmlFor={name} className="block text-sm font-medium text-gray-700">{label}</label>
    <input
      type={type}
      name={name}
      id={name}
      value={value}
      onChange={onChange}
      required={required}
      placeholder={placeholder}
      {...props}
      className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
    />
  </div>
);

const FormSelect = ({ label, name, value, onChange, required = false, children }) => (
  <div>
    <label htmlFor={name} className="block text-sm font-medium text-gray-700">{label}</label>
    <select
      name={name}
      id={name}
      value={value}
      onChange={onChange}
      required={required}
      className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
    >
      {children}
    </select>
  </div>
);

const FormTextArea = ({ label, name, value, onChange, placeholder = '', rows = 4 }) => (
  <div>
    <label htmlFor={name} className="block text-sm font-medium text-gray-700">{label}</label>
    <textarea
      name={name}
      id={name}
      rows={rows}
      value={value}
      onChange={onChange}
      className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
      placeholder={placeholder}
    ></textarea>
  </div>
);

// --- Yodha Form Component (for Add and Edit) ---
const YodhaForm = ({ 
  initialData, 
  onSubmit, 
  onCancel, 
  isEdit = false, 
  districts = [], 
  onManageDistrictClick, 
  states = [],
  onManageStateClick, 
  categories = [],
  onManageCategoryClick 
}) => {
  const [formData, setFormData] = useState(initialData);

  // This effect synchronizes the form data when initialData (for editing) changes
  useEffect(() => {
    setFormData(initialData);
  }, [initialData]);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.accusedName) {
      // Parent component handles error display
    }
    
    // onSubmit now returns a promise
    const success = await onSubmit(formData);
    if (success && !isEdit) {
      // Reset form on successful add
      setFormData(initialData);
    }
  };


  return (
    <form onSubmit={handleSubmit} className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
      <FormInput label="Yodha Number" name="yodhaNumber" value={formData.yodhaNumber} onChange={handleInputChange} />
      <FormInput label="Accused Name" name="accusedName" value={formData.accusedName} onChange={handleInputChange} required={true} />
      
      {/* --- District Select with Manage Button --- */}
      <div>
        <label htmlFor="district" className="block text-sm font-medium text-gray-700">District</label>
        <div className="flex items-center gap-2 mt-1">
          <select
            name="district"
            id="district"
            value={formData.district || ''}
            onChange={handleInputChange}
            className="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
          >
            <option value="">Select a district...</option>
            {districts.map(d => (
              <option key={d.id} value={d.name}>{d.name}</option>
            ))}
          </select>
          <button
            type="button"
            onClick={onManageDistrictClick} 
            className="flex-shrink-0 p-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
            aria-label="Manage districts"
          >
            <PlusIcon />
          </button>
        </div>
      </div>
      
      <FormInput label="Village" name="village" value={formData.village} onChange={handleInputChange} />

      {/* --- State Select with Manage Button --- */}
      <div>
        <label htmlFor="state" className="block text-sm font-medium text-gray-700">State</label>
        <div className="flex items-center gap-2 mt-1">
          <select
            name="state"
            id="state"
            value={formData.state || ''}
            onChange={handleInputChange}
            className="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
          >
            <option value="">Select a state...</option>
            {states.map(s => (
              <option key={s.id} value={s.name}>{s.name}</option>
            ))}
          </select>
          <button
            type="button"
            onClick={onManageStateClick} 
            className="flex-shrink-0 p-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
            aria-label="Manage states"
          >
            <PlusIcon />
          </button>
        </div>
      </div>
      
      <FormInput label="Incident Date" name="incidentDate" value={formData.incidentDate} onChange={handleInputChange} type="date" />

      {/* --- Category Select with Manage Button --- */}
      <div>
        <label htmlFor="category" className="block text-sm font-medium text-gray-700">Category</label>
        <div className="flex items-center gap-2 mt-1">
          <select
            name="category"
            id="category"
            value={formData.category || ''}
            onChange={handleInputChange}
            className="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
          >
            <option value="">Select a category...</option>
            {categories.map(c => (
              <option key={c.id} value={c.name}>{c.name}</option>
            ))}
          </select>
          <button
            type="button"
            onClick={onManageCategoryClick} 
            className="flex-shrink-0 p-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
            aria-label="Manage categories"
          >
            <PlusIcon />
          </button>
        </div>
      </div>
      
      <h3 className="text-lg font-medium text-gray-800 pt-2 border-t mt-4">Karyakarta Details</h3>
      <FormInput 
        label="Local Karyakarta Name and Number" 
        name="localKaryakarta" 
        value={formData.localKaryakarta} 
        onChange={handleInputChange} 
        placeholder="e.g., Ramesh Kumar - 98XXXXX" 
      />
      <FormInput 
        label="Main Karyakarta Name and Number" 
        name="mainKaryakarta" 
        value={formData.mainKaryakarta} 
        onChange={handleInputChange} 
        placeholder="e.g., Suresh Singh - 97XXXXX" 
      />

      <h3 className="text-lg font-medium text-gray-800 pt-2 border-t mt-4">Case Status</h3>
      <FormSelect label="Contact Established" name="contactEstablished" value={formData.contactEstablished} onChange={handleInputChange} required={true}>
        <option value="">Select...</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </FormSelect>
      <FormSelect label="Reached Help" name="helpReached" value={formData.helpReached} onChange={handleInputChange} required={true}>
        <option value="">Select...</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </FormSelect>
      <FormSelect label="FIR Registered" name="firRegistered" value={formData.firRegistered} onChange={handleInputChange} required={true}>
        <option value="">Select...</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </FormSelect>
      <FormInput label="Deceased Name (if any)" name="deceasedName" value={formData.deceasedName} onChange={handleInputChange} />
      <FormTextArea label="Case Details" name="caseDetails" value={formData.caseDetails} onChange={handleInputChange} placeholder="Describe the case details..." />
      
      <div className="flex gap-4 pt-4">
        <button
          type="submit"
          className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors"
        >
          {isEdit ? 'Save Changes' : 'Add Yodha'}
        </button>
        {onCancel && (
          <button
            type="button"
            onClick={onCancel}
            className="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
          >
            Cancel
          </button>
        )}
      </div>
    </form>
  );
};

// --- Modal Component ---
const Modal = ({ children, onClose, size = 'md' }) => {
  const sizeClass = size === 'md' ? 'max-w-md' : 'max-w-xs';
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" onClick={onClose}>
      <div className={`bg-white p-6 rounded-xl shadow-lg w-full ${sizeClass}`} onClick={(e) => e.stopPropagation()}>
        {children}
      </div>
    </div>
  );
};

// --- Yodha Details Modal (NEW) ---
const YodhaDetailsModal = ({ yodha, onClose, onEdit, onDelete }) => {
  // Helper to render Yodha details
  const renderDetail = (label, value) => {
    if (!value) return null;
    return (
      <div className="py-2 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt className="text-sm font-medium text-gray-500">{label}</dt>
        <dd className="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{value}</dd>
      </div>
    );
  };

  // Helper for 'Yes/No' fields
  const renderStatus = (label, value) => {
    if (!value) return null;
    const color = value === 'yes' ? 'text-green-600' : 'text-red-600';
    return (
      <div className="py-2 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt className="text-sm font-medium text-gray-500">{label}</dt>
        <dd className="mt-1 text-sm font-semibold sm:mt-0 sm:col-span-2">
          <span className={`${color} capitalize`}>{value}</span>
        </dd>
      </div>
    );
  };

  // --- NEW: PDF Generation Handler ---
  const handleGeneratePdf = () => {
    // Check if jsPDF library is loaded (it's loaded in App.js)
    if (!window.jspdf) {
      console.error("jsPDF library not loaded yet.");
      // In a real app, you'd show a user-friendly error.
      // For now, we'll just log and return.
      return; 
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Set Title
    doc.setFont('Helvetica', 'bold');
    doc.setFontSize(20);
    doc.text(yodha.accusedName, 10, 20);

    doc.setFont('Helvetica', 'normal');
    doc.setFontSize(12);
    let y = 30; // Vertical position tracker

    // Helper function to add lines
    const addLine = (text) => {
      if (text) {
        doc.text(text, 10, y);
        y += 7; // Increment line position
      }
    };
    
    // Helper to add bold section headers
    const addHeader = (text) => {
      y += 3; // Small spacer
      doc.setFont('Helvetica', 'bold');
      addLine(text);
      doc.setFont('Helvetica', 'normal');
    };

    // --- Add Content ---
    addLine(`Yodha Number: ${yodha.yodhaNumber || 'N/A'}`);
    const location = [yodha.village, yodha.district, yodha.state].filter(Boolean).join(', ');
    addLine(`Location: ${location || 'N/A'}`);
    addLine(`Incident Date: ${yodha.incidentDate || 'N/A'}`);
    addLine(`Category: ${yodha.category || 'N/A'}`);
    addLine(`Deceased Name: ${yodha.deceasedName || 'N/A'}`);
    
    addHeader('Karyakarta Details:');
    addLine(`  Local: ${yodha.localKaryakarta || 'N/A'}`);
    addLine(`  Main: ${yodha.mainKaryakarta || 'N/A'}`);
    
    addHeader('Case Status:');
    addLine(`  Contact Established: ${yodha.contactEstablished ? yodha.contactEstablished.toUpperCase() : 'N/A'}`);
    addLine(`  Help Reached: ${yodha.helpReached ? yodha.helpReached.toUpperCase() : 'N/A'}`);
    addLine(`  FIR Registered: ${yodha.firRegistered ? yodha.firRegistered.toUpperCase() : 'N/A'}`);
    
    addHeader('Case Details:');
    const details = yodha.caseDetails || 'N/A';
    // Use splitTextToSize to handle long text and wrap it
    const splitDetails = doc.splitTextToSize(details, 180); // 180mm width
    doc.text(splitDetails, 10, y);
    
    // --- Save the PDF ---
    // Create a filename-safe string
    const filename = `${yodha.accusedName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_details.pdf`;
    doc.save(filename);
  };


  return (
    <Modal onClose={onClose} size="md">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-2xl font-bold text-orange-700">{yodha.accusedName}</h3>
        <button
          onClick={onClose}
          className="p-1 text-gray-400 hover:text-gray-600 rounded-full focus:outline-none"
          aria-label="Close"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
            <path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div className="max-h-[60vh] overflow-y-auto pr-2">
        <dl className="divide-y divide-gray-200">
          {renderDetail("Yodha Number", yodha.yodhaNumber)}
          {renderDetail("Location", [yodha.village, yodha.district, yodha.state].filter(Boolean).join(', '))}
          {renderDetail("Incident Date", yodha.incidentDate)}
          {renderDetail("Category", yodha.category)}
          {renderDetail("Deceased Name", yodha.deceasedName)}
          {renderDetail("Local Karyakarta", yodha.localKaryakarta)}
          {renderDetail("Main Karyakarta", yodha.mainKaryakarta)}
          {renderStatus("Contact Established", yodha.contactEstablished)}
          {renderStatus("Help Reached", yodha.helpReached)}
          {renderStatus("FIR Registered", yodha.firRegistered)}
          {renderDetail("Case Details", yodha.caseDetails)}
        </dl>
      </div>

      {/* --- MODIFIED Footer with Share Button --- */}
      <div className="flex justify-end gap-4 mt-6 pt-4 border-t">
        <button
          onClick={handleGeneratePdf}
          className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center gap-2"
        >
          <ShareIcon />
          Share (PDF)
        </button>
        <button
          onClick={onEdit}
          className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center gap-2"
        >
          <PencilIcon />
          Edit
        </button>
        <button
          onClick={onDelete}
          className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex items-center gap-2"
        >
          <TrashIcon />
          Delete
        </button>
      </div>
    </Modal>
  );
};


// --- Delete Confirmation Modal ---
const DeleteConfirmationModal = ({ onConfirm, onCancel }) => (
  <Modal onClose={onCancel} size="md">
    <h3 className="text-xl font-semibold text-gray-900 mb-4">Confirm Deletion</h3>
    <p className="text-gray-600 mb-6">Are you sure you want to delete this entry? This action cannot be undone.</p>
    <div className="flex justify-end gap-4">
      <button
        onClick={onCancel}
        className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
      >
        Cancel
      </button>
      <button
        onClick={onConfirm}
        className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
      >
        Delete
      </button>
    </div>
  </Modal>
);

// --- NEW Generic List Management Modal ---
const ManageListModal = ({ title, items, onConfirmAdd, onConfirmDelete, onCancel, placeholder }) => {
  const [newItemName, setNewItemName] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (newItemName.trim()) {
      onConfirmAdd(newItemName.trim());
      setNewItemName(''); // Clear input after adding
    }
  };

  return (
    <Modal onClose={onCancel} size="md">
      <h3 className="text-xl font-semibold text-gray-900 mb-4">{title}</h3>
      
      {/* --- Add New Item Form --- */}
      <form onSubmit={handleSubmit} className="space-y-2 mb-4">
        <label htmlFor="newItemName" className="block text-sm font-medium text-gray-700">Add New {placeholder}</label>
        <div className="flex items-center gap-2">
          <input
            type="text"
            name="newItemName"
            id="newItemName"
            value={newItemName}
            onChange={(e) => setNewItemName(e.target.value)}
            placeholder={`e.g., ${placeholder}`}
            className="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
          />
          <button
            type="submit"
            className="flex-shrink-0 px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
            aria-label="Add new item"
          >
            Add
          </button>
        </div>
      </form>

      {/* --- List of Existing Items --- */}
      <h4 className="text-md font-medium text-gray-800 mb-2">Existing Items</h4>
      <div className="max-h-60 overflow-y-auto pr-2 space-y-2 border p-3 rounded-md bg-gray-50">
        {items.length === 0 ? (
          <p className="text-gray-500 text-sm text-center">No items created yet.</p>
        ) : (
          items.map(item => (
            <div key={item.id} className="flex justify-between items-center p-2 bg-white rounded-md shadow-sm">
              <span className="text-gray-800">{item.name}</span>
              <button
                onClick={() => onConfirmDelete(item.id)}
                className="p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100"
                aria-label={`Delete ${item.name}`}
              >
                <TrashIcon />
              </button>
            </div>
          ))
        )}
      </div>

      <div className="flex justify-end mt-6">
        <button
          onClick={onCancel}
          type="button"
          className="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
        >
          Done
        </button>
      </div>
    </Modal>
  );
};

// --- List of Indian States ---
const indianStates = [
  "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", 
  "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", 
  "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", 
  "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", 
  "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
];

// --- One-time function to pre-populate states ---
const prepopulateStates = async (db, userId) => {
  try {
    const settingsDocRef = doc(db, `/users/${userId}/app_settings/initFlags`);
    const settingsDoc = await getDoc(settingsDocRef);

    // Check if states are already pre-populated
    if (settingsDoc.exists() && settingsDoc.data().states_prepopulated) {
      console.log("States are already pre-populated.");
      return;
    }

    console.log("Pre-populating states for the first time...");

    const statesCollRef = collection(db, `/users/${userId}/states`);
    const existingStatesSnap = await getDocs(statesCollRef);
    const existingStateNames = new Set(existingStatesSnap.docs.map(d => d.data().name.toLowerCase()));
    
    indianStates.forEach(stateName => {
      if (!existingStateNames.has(stateName.toLowerCase())) {
        // We don't need to await each one, just add to a batch
        // But for simplicity and to avoid batch write imports, we'll add them sequentially
        // This logic is simple and will run only once anyway.
        addDoc(statesCollRef, { name: stateName });
      }
    });

    // Set the flag so this doesn't run again
    await setDoc(settingsDocRef, { states_prepopulated: true });
    console.log("States pre-population complete.");

  } catch (err) {
    console.error("Error in pre-populating states: ", err);
    // Don't block the app if this fails, just log it.
  }
};


// --- NEW: Define initialFormData OUTSIDE the component ---
// By defining this here, its reference remains stable and won't reset the form on re-renders.
const initialFormData = {
  yodhaNumber: '', accusedName: '', district: '', village: '', state: '', incidentDate: '', category: '',
  localKaryakarta: '', mainKaryakarta: '',
  contactEstablished: '', helpReached: '', deceasedName: '', firRegistered: '', caseDetails: ''
};


// --- NEW: Accounts View Component ---
const AccountsView = ({ yodhas, transactions, onAddTransaction, error, setError }) => {
  const initialTxData = { yodhaId: '', amount: '', date: '' };
  const [txData, setTxData] = useState(initialTxData);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setTxData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSubmitting(true);
    setError(''); // Clear old errors
    
    const success = await onAddTransaction(txData);
    
    if (success) {
      setTxData(initialTxData); // Reset form
    }
    setIsSubmitting(false);
  };

  // --- Data Processing for Summaries ---
  const { totalAmount, yodhaBreakdown } = React.useMemo(() => {
    const total = transactions.reduce((sum, tx) => sum + tx.amount, 0);
    
    const breakdown = transactions.reduce((acc, tx) => {
      const name = tx.yodhaName || 'Unknown Yodha';
      if (!acc[name]) {
        acc[name] = { total: 0, count: 0 };
      }
      acc[name].total += tx.amount;
      acc[name].count += 1;
      return acc;
    }, {});

    // Sort by total amount, descending
    const sortedBreakdown = Object.entries(breakdown)
      .map(([name, data]) => ({ name, ...data }))
      .sort((a, b) => b.total - a.total);
      
    return { totalAmount: total, yodhaBreakdown: sortedBreakdown };
  }, [transactions]); // Recalculate only when transactions change

  // Helper to format currency
  const formatCurrency = (num) => {
    return new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(num);
  };

  return (
    <div className="flex flex-col md:flex-row md:gap-8">
      
      {/* --- Left Column: Add Transaction Form & Summary --- */}
      <div className="md:w-1/3 w-full mb-8 md:mb-0 space-y-6">
        
        {/* --- Add Transaction Form --- */}
        <div className="bg-white p-6 rounded-xl shadow-lg">
          <h2 className="text-2xl font-semibold text-gray-900 mb-6">Add Transaction</h2>
          
          {/* Display Form-Specific Errors */}
          {error && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
              <span className="block sm:inline">{error}</span>
              <button onClick={() => setError('')} className="absolute top-0 bottom-0 right-0 px-4 py-3"><span className="text-xl">&times;</span></button>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            <FormSelect label="Select Yodha" name="yodhaId" value={txData.yodhaId} onChange={handleInputChange} required={true}>
              <option value="">Select a Yodha...</option>
              {yodhas.map(y => (
                <option key={y.id} value={y.id}>{y.accusedName}</option>
              ))}
            </FormSelect>
            <FormInput label="Amount (INR)" name="amount" value={txData.amount} onChange={handleInputChange} type="number" step="0.01" min="0" required={true} placeholder="e.g., 5000" />
            <FormInput label="Date" name="date" value={txData.date} onChange={handleInputChange} type="date" required={true} />
            <button
              type="submit"
              disabled={isSubmitting}
              className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors disabled:bg-gray-400"
            >
              {isSubmitting ? 'Saving...' : 'Save Transaction'}
            </button>
          </form>
        </div>

        {/* --- Total Summary Card --- */}
        <div className="bg-white p-6 rounded-xl shadow-lg text-center">
          <h3 className="text-lg font-medium text-gray-500 mb-2">Total Amount Disbursed</h3>
          <p className="text-4xl font-bold text-orange-700">{formatCurrency(totalAmount)}</p>
        </div>
      </div>

      {/* --- Right Column: Breakdown by Yodha --- */}
      <div className="md:w-2/3 w-full">
        <h2 className="text-2xl font-semibold text-gray-900 mb-6">Breakdown by Yodha</h2>
        {transactions.length === 0 ? (
          <div className="bg-white text-center p-12 rounded-xl shadow-lg">
            <p className="text-gray-500">No transactions have been added yet.</p>
          </div>
        ) : (
          <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
            {yodhaBreakdown.map((yodha) => (
              <div key={yodha.name} className="bg-white p-5 rounded-xl shadow-lg flex justify-between items-center">
                <div>
                  <h3 className="text-xl font-bold text-orange-700">{yodha.name}</h3>
                  <p className="text-sm text-gray-500">{yodha.count} transaction(s)</p>
                </div>
                <span className="text-2xl font-semibold text-gray-800">{formatCurrency(yodha.total)}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};


// --- NEW: Analysis Components ---

// Define colors (using the theme)
const PIE_COLORS = ['#FF8042', '#FFBB28', '#00C49F', '#0088FE', '#AF19FF', '#FB923C']; // Added one more orange

// Reusable Pie Chart
const SimplePieChart = ({ data, title }) => (
  <div className="bg-white p-6 rounded-xl shadow-lg h-96">
    <h3 className="text-xl font-semibold text-gray-900 mb-4">{title}</h3>
    <ResponsiveContainer width="100%" height="90%">
      <PieChart margin={{ top: 0, right: 0, bottom: 0, left: 0 }}>
        <Pie
          data={data}
          cx="50%"
          cy="50%"
          outerRadius={100}
          fill="#8884d8"
          dataKey="value"
          label={({ name, percent }) => `${name} (${(percent * 100).toFixed(0)}%)`}
          labelLine={false}
        >
          {data.map((entry, index) => (
            <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />
          ))}
        </Pie>
        <Tooltip />
        <Legend layout="horizontal" verticalAlign="bottom" align="center" />
      </PieChart>
    </ResponsiveContainer>
  </div>
);

// Reusable Bar Chart
const SimpleBarChart = ({ data, title, dataKey }) => (
    <div className="bg-white p-6 rounded-xl shadow-lg h-96">
    <h3 className="text-xl font-semibold text-gray-900 mb-4">{title}</h3>
    <ResponsiveContainer width="100%" height="90%">
      <BarChart data={data} layout="vertical" margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis type="number" />
        <YAxis dataKey="name" type="category" width={100} interval={0} />
        <Tooltip />
        <Bar dataKey={dataKey} fill="#F97316" /> {/* Orange color */}
      </BarChart>
    </ResponsiveContainer>
  </div>
);

// Main Analysis View
const AnalysisView = ({ yodhas }) => {
  // useMemo will prevent re-calculating this data on every render
  const { stateData, categoryData, firData, helpData } = React.useMemo(() => {
    // Helper to count occurrences of a field
    const countBy = (field) => {
      return yodhas.reduce((acc, yodha) => {
        let key = yodha[field] || 'Unknown';
        if (key === '') key = 'Unknown';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
    };

    // Helper to format the counted data for recharts
    const formatForChart = (data) => {
      return Object.entries(data)
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => b.value - a.value); // Sort descending
    };

    return {
      stateData: formatForChart(countBy('state')),
      categoryData: formatForChart(countBy('category')),
      firData: formatForChart(countBy('firRegistered')),
      helpData: formatForChart(countBy('helpReached')),
    };
  }, [yodhas]); // Only re-run when the yodhas list changes

  if (yodhas.length === 0) {
    return (
      <div className="bg-white p-8 rounded-xl shadow-lg text-center">
        <h2 className="text-2xl font-semibold text-gray-900 mb-4">
          Analysis
        </h2>
        <p className="text-gray-600">
          No data to analyze. Add Yodhas to the database to see charts here.
        </p>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Bar charts are better for high-cardinality data */}
      <SimpleBarChart data={stateData} title="Yodhas by State" dataKey="value" />
      <SimpleBarChart data={categoryData} title="Yodhas by Category" dataKey="value" />
      
      {/* Pie charts are good for low-cardinality data */}
      <SimplePieChart data={firData} title="FIR Registered Status" />
      <SimplePieChart data={helpData} title="Help Reached Status" />
    </div>
  );
};


// --- Main App Component ---
export default function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  
  const [yodhas, setYodhas] = useState([]);
  const [transactions, setTransactions] = useState([]); // --- NEW: State for transactions ---
  const [districts, setDistricts] = useState([]); // --- State for districts ---
  const [states, setStates] = useState([]); // --- State for states ---
  const [categories, setCategories] = useState([]); // --- State for categories ---
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState('');
  const [searchQuery, setSearchQuery] = useState(''); // --- State for search query ---
  
  // --- State for current view ---
  const [currentView, setCurrentView] = useState('database'); // 'database', 'accounts', or 'analysis'

  // --- State for Modals ---
  const [editingYodha, setEditingYodha] = useState(null); // Holds Yodha object for editing
  const [deletingYodhaId, setDeletingYodhaId] = useState(null); // Holds Yodha ID for deletion confirmation
  const [viewingYodha, setViewingYodha] = useState(null); // --- State for details modal (NEW) ---
  const [isManagingDistricts, setIsManagingDistricts] = useState(false); 
  const [isManagingStates, setIsManagingStates] = useState(false); 
  const [isManagingCategories, setIsManagingCategories] = useState(false); 

  // --- NEW Navigation State ---
  const [navigationLevel, setNavigationLevel] = useState('states'); // 'states', 'districts', 'yodhas'
  const [selectedState, setSelectedState] = useState(null);
  const [selectedDistrict, setSelectedDistrict] = useState(null);

  // --- NEW: Auth State ---
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [pinInput, setPinInput] = useState('');
  const [pinError, setPinError] = useState('');
  const correctPin = '1406';

  // Effect 1: Initialize Firebase and Authenticate
  useEffect(() => {
    let authUnsubscribe = null;
    try {
      const app = initializeApp(firebaseConfig);
      const authInstance = getAuth(app);
      const dbInstance = getFirestore(app);
      setLogLevel('Debug'); 

      setAuth(authInstance);
      setDb(dbInstance);

      authUnsubscribe = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUserId(user.uid);
          // --- Call pre-population logic here ---
          await prepopulateStates(dbInstance, user.uid);
          // ------------------------------------
        } else {
          try {
            // NOTE: Custom token auth is disabled. Forcing anonymous sign-in.
            // Your project MUST have Anonymous Sign-in enabled in Firebase Auth.
            await signInAnonymously(authInstance);
          } catch (authError) {
            console.error("Authentication Error:", authError);
            setError("Failed to authenticate. Please refresh the page.");
          }
        }
      });
    } catch (e) {
      console.error("Firebase Initialization Error:", e);
      setError("Failed to initialize the application. Please check the console.");
      setIsLoading(false);
    }

    // --- NEW: Load jsPDF script ---
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    script.async = true;
    script.onload = () => console.log('jsPDF library loaded.');
    script.onerror = () => console.error('Failed to load jsPDF library.');
    document.head.appendChild(script);
    // --------------------------------
    
    return () => {
      if (authUnsubscribe) authUnsubscribe();
      // Clean up script if component unmounts
      if (document.head.contains(script)) {
          document.head.removeChild(script);
      }
    };
  }, []); // Empty array, runs once on mount.

  // Effect 2: Set up Firestore real-time listener for Yodhas
  useEffect(() => {
    if (!db || !userId) {
      return;
    }
    
    // We always need yodhas data for the analysis tab
    // so we remove the `currentView` check
    
    setIsLoading(true);
    const collPath = `/users/${userId}/yodhas`;
    const yodhasCollection = collection(db, collPath);
    const q = query(yodhasCollection);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const yodhasData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      yodhasData.sort((a, b) => {
        const nameA = a.accusedName || '';
        const nameB = b.accusedName || '';
        return nameA.localeCompare(nameB);
      });
      setYodhas(yodhasData);
      setIsLoading(false);
      setError('');
    }, (err) => {
      console.error("Firestore Yodhas Snapshot Error:", err);
      setError("Failed to load data from the database.");
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [db, userId]); // Removed currentView, so Yodhas are always fetched
  
  // Effect 3: Set up Firestore real-time listener for Districts
  useEffect(() => {
    if (!db || !userId) return;

    const collPath = `/users/${userId}/districts`;
    const q = query(collection(db, collPath));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const districtData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      districtData.sort((a, b) => a.name.localeCompare(b.name));
      setDistricts(districtData);
    }, (err) => {
      console.error("Firestore Districts Snapshot Error:", err);
      setError("Failed to load districts list.");
    });

    return () => unsubscribe();
  }, [db, userId]);

  // Effect 4: Set up Firestore real-time listener for States
  useEffect(() => {
    if (!db || !userId) return;

    const collPath = `/users/${userId}/states`;
    const q = query(collection(db, collPath));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const stateData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      stateData.sort((a, b) => a.name.localeCompare(b.name));
      setStates(stateData);
    }, (err) => {
      console.error("Firestore States Snapshot Error:", err);
      setError("Failed to load states list.");
    });

    return () => unsubscribe();
  }, [db, userId]);

  // Effect 5: Set up Firestore real-time listener for Categories
  useEffect(() => {
    if (!db || !userId) return;

    const collPath = `/users/${userId}/categories`;
    const q = query(collection(db, collPath));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const categoryData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      categoryData.sort((a, b) => a.name.localeCompare(b.name));
      setCategories(categoryData);
    }, (err) => {
      console.error("Firestore Categories Snapshot Error:", err);
      setError("Failed to load categories list.");
    });

    return () => unsubscribe();
  }, [db, userId]);
  
  // --- NEW: Effect 6: Set up Firestore real-time listener for Transactions ---
  useEffect(() => {
    if (!db || !userId) return;

    const collPath = `/users/${userId}/transactions`;
    const q = query(collection(db, collPath));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const txData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      // Ensure amount is a number for calculations
      txData.forEach(tx => tx.amount = parseFloat(tx.amount) || 0);
      txData.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date, newest first
      setTransactions(txData);
    }, (err) => {
      console.error("Firestore Transactions Snapshot Error:", err);
      setError("Failed to load transactions list.");
    });

    return () => unsubscribe();
  }, [db, userId]);


  // --- Form Handlers ---
  
  const handleAddSubmit = async (formData) => {
    if (!db || !userId) {
       setError("Database is not connected. Please wait.");
       return false;
    }

    try {
      const collPath = `/users/${userId}/yodhas`;
      await addDoc(collection(db, collPath), formData);
      setError('');
      return true; // Return true to signal form reset
    } catch (e) {
      console.error("Error adding document: ", e);
      setError("Failed to add Yodha. Please try again.");
      return false; // Return false on failure
    }
  };

  const handleUpdateSubmit = async (formData) => {
    if (!db || !userId || !editingYodha) {
       setError("Database is not connected. Please wait.");
       return;
    }

    try {
      const docPath = `/users/${userId}/yodhas/${editingYodha.id}`;
      // Remove 'id' from data before sending, as it's not part of the document fields
      const { id, ...dataToUpdate } = formData; 
      await updateDoc(doc(db, docPath), dataToUpdate);
      setEditingYodha(null); // Close modal
      setError('');
    } catch (e) {
      console.error("Error updating document: ", e);
      setError("Failed to update Yodha. Please try again.");
    }
  };

  const handleConfirmDelete = async () => {
    if (!db || !userId || !deletingYodhaId) {
       setError("Database is not connected. Please wait.");
       return;
    }

    try {
      const docPath = `/users/${userId}/yodhas/${deletingYodhaId}`;
      await deleteDoc(doc(db, docPath));
      setDeletingYodhaId(null); // Close modal
      setError('');
    } catch (e) {
      console.error("Error deleting document: ", e);
      setError("Failed to delete Yodha. Please try again.");
    }
  };
  
  // --- NEW: Transaction Handler ---
  const handleAddTransaction = async (txData) => {
    if (!db || !userId) {
       setError("Database is not connected.");
       return false;
    }
    
    const { yodhaId, amount, date } = txData;
    
    if (!yodhaId || !amount || !date) {
      setError("Please fill all transaction fields.");
      return false;
    }
    
    const selectedYodha = yodhas.find(y => y.id === yodhaId);
    if (!selectedYodha) {
       setError("Selected Yodha not found.");
       return false;
    }

    try {
      const collPath = `/users/${userId}/transactions`;
      await addDoc(collection(db, collPath), {
        yodhaId: yodhaId,
        yodhaName: selectedYodha.accusedName, // Denormalize name
        amount: parseFloat(amount),
        date: date,
      });
      setError('');
      return true; // Success
    } catch (e) {
      console.error("Error adding transaction: ", e);
      setError("Failed to add transaction.");
      return false; // Failure
    }
  };

  // --- List Management Handlers (Add) ---
  const handleAddItem = async (collectionName, itemName) => {
    if (!db || !userId) {
       setError("Database is not connected. Please wait.");
       return;
    }
    
    let currentList = [];
    if (collectionName === 'districts') currentList = districts;
    else if (collectionName === 'states') currentList = states;
    else if (collectionName === 'categories') currentList = categories;

    const lowerCaseName = itemName.trim().toLowerCase();
    const exists = currentList.some(i => i.name.toLowerCase() === lowerCaseName);
    
    if (exists) {
      setError(`This ${collectionName.slice(0, -1)} already exists.`);
      return;
    }

    try {
      const collPath = `/users/${userId}/${collectionName}`;
      await addDoc(collection(db, collPath), { name: itemName.trim() });
      setError('');
    } catch (e) {
      console.error(`Error adding ${collectionName}: `, e);
      setError(`Failed to add new ${collectionName.slice(0, -1)}.`);
    }
  };

  // --- List Management Handlers (Delete) ---
  const handleDeleteItem = async (collectionName, id) => {
    if (!db || !userId) {
      setError("Database is not connected.");
      return;
    }
    
    let itemField = '';
    let currentList = [];
    if (collectionName === 'districts') {
      itemField = 'district';
      currentList = districts;
    }
    else if (collectionName === 'states') {
       itemField = 'state';
       currentList = states;
    }
    else if (collectionName === 'categories') {
      itemField = 'category';
      currentList = categories;
    }

    const itemToDelete = currentList.find(i => i.id === id);
    const inUse = yodhas.some(y => y[itemField] === itemToDelete?.name);
    
    if (inUse) {
      setError(`Cannot delete. This ${itemField} is in use by a Yodha entry.`);
      return;
    }
    try {
      const docPath = `/users/${userId}/${collectionName}/${id}`;
      await deleteDoc(doc(db, docPath));
      setError('');
    } catch (e)
    {
      console.error(`Error deleting ${itemField}: `, e);
      setError(`Failed to delete ${itemField}.`);
    }
  };

  // --- NEW: PIN Submit Handler ---
  const handlePinSubmit = (e) => {
    e.preventDefault();
    if (pinInput === correctPin) {
      setIsAuthenticated(true);
      setPinError('');
      setPinInput(''); // Clear the pin input
    } else {
      setPinError('Incorrect PIN. Please try again.');
      setPinInput(''); // Clear the pin input
    }
  };

  // --- Helper to render Yodha details ---
  const renderDetail = (label, value) => {
    if (!value) return null;
    return (
      <p className="text-sm">
        <span className="font-medium text-gray-600">{label}:</span> {value}
      </p>
    );
  };

  // Helper for 'Yes/No' fields
  const renderStatus = (label, value) => {
    if (!value) return null;
    const color = value === 'yes' ? 'text-green-600' : 'text-red-600';
    return (
       <p className="text-sm">
        <span className="font-medium text-gray-600">{label}:</span>
        <span className={`font-semibold ${color} ml-1 capitalize`}>{value}</span>
      </p>
    );
  }

  // --- NEW: Data processing for navigation ---
  const { statesWithCount, districtsWithCount, yodhasInDistrict } = React.useMemo(() => {
    const query = searchQuery.toLowerCase().trim();

    // 1. Group all yodhas by state and district
    const stateGroups = {};
    yodhas.forEach(yodha => {
      const state = yodha.state || 'Uncategorized';
      const district = yodha.district || 'Uncategorized';

      if (!stateGroups[state]) {
        stateGroups[state] = { count: 0, districts: {} };
      }
      stateGroups[state].count++;
      
      if (!stateGroups[state].districts[district]) {
        stateGroups[state].districts[district] = { count: 0 };
      }
      stateGroups[state].districts[district].count++;
    });

    // 2. Get states list, filtered by search
    const statesWithCount = Object.entries(stateGroups)
      .map(([name, data]) => ({ name, count: data.count, districts: data.districts }))
      .filter(s => s.name.toLowerCase().includes(query))
      .sort((a, b) => a.name.localeCompare(b.name));

    // 3. Get districts for selected state, filtered by search
    let districtsWithCount = [];
    if (selectedState && stateGroups[selectedState]) {
      districtsWithCount = Object.entries(stateGroups[selectedState].districts)
        .map(([name, data]) => ({ name, count: data.count }))
        .filter(d => d.name.toLowerCase().includes(query))
        .sort((a, b) => a.name.localeCompare(b.name));
    }
    
    // 4. Get yodhas for selected district, filtered by search
    let yodhasInDistrict = [];
    if (selectedState && selectedDistrict) {
      yodhasInDistrict = yodhas.filter(y => {
        const state = y.state || 'Uncategorized';
        const district = y.district || 'Uncategorized';
        
        if (state !== selectedState || district !== selectedDistrict) {
          return false;
        }

        // Apply search query to yodha fields
        if (!query) return true;
        const searchableText = [
          y.accusedName, y.yodhaNumber, y.village, y.category,
          y.localKaryakarta, y.mainKaryakarta, y.deceasedName, y.caseDetails
        ].filter(Boolean).join(' ').toLowerCase();
        
        return searchableText.includes(query);
      });
    }

    return { statesWithCount, districtsWithCount, yodhasInDistrict };
  }, [yodhas, searchQuery, selectedState, selectedDistrict]);


  // --- NEW Navigation Handlers ---
  const handleStateClick = (stateName) => {
    setSelectedState(stateName);
    setNavigationLevel('districts');
    setSearchQuery(''); // Clear search when drilling down
  };

  const handleDistrictClick = (districtName) => {
    setSelectedDistrict(districtName);
    setNavigationLevel('yodhas');
    setSearchQuery(''); // Clear search when drilling down
  };

  const handleBreadcrumbClick = (level) => {
    setSearchQuery(''); // Clear search when navigating
    if (level === 'states') {
      setSelectedState(null);
      setSelectedDistrict(null);
      setNavigationLevel('states');
    } else if (level === 'districts') {
      setSelectedDistrict(null);
      setNavigationLevel('districts');
    }
  };
  
  // --- NEW Breadcrumbs Component ---
  const Breadcrumbs = () => (
    <nav className="flex items-center gap-2 text-sm font-medium text-gray-500 mb-4">
      <button
        onClick={() => handleBreadcrumbClick('states')}
        className={`hover:text-orange-600 ${navigationLevel === 'states' ? 'text-orange-600' : ''}`}
      >
        All States
      </button>
      {selectedState && (
        <>
          <span>&gt;</span>
          <button
            onClick={() => handleBreadcrumbClick('districts')}
            disabled={navigationLevel === 'districts'}
            className={`hover:text-orange-600 ${navigationLevel === 'districts' ? 'text-orange-600' : ''} ${navigationLevel === 'yodhas' ? '' : 'cursor-default'}`}
          >
            {selectedState}
          </button>
        </>
      )}
      {selectedDistrict && (
        <>
          <span>&gt;</span>
          <span className="text-orange-600">{selectedDistrict}</span>
        </>
      )}
    </nav>
  );
  
  // --- NEW Clickable Card for Navigation ---
  const NavigationCard = ({ title, count, onClick }) => (
    <button
      onClick={onClick}
      className="w-full bg-white p-5 rounded-xl shadow-lg transition-all hover:shadow-md hover:bg-orange-50 flex justify-between items-center text-left"
    >
      <div>
        <h3 className="text-xl font-bold text-orange-700">{title}</h3>
      </div>
      <div className="flex items-center gap-2">
        <span className="px-3 py-1 bg-orange-100 text-orange-800 text-sm font-semibold rounded-full">{count}</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-gray-400">
          <path strokeLinecap="round" strokeLinejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
        </svg>
      </div>
    </button>
  );

  // --- NEW Yodha Summary Card ---
  const YodhaCard = ({ yodha, onClick }) => (
    <button
      onClick={onClick}
      className="w-full bg-white p-5 rounded-xl shadow-lg transition-all hover:shadow-md hover:bg-orange-50 text-left"
    >
      <h3 className="text-xl font-bold text-orange-700">{yodha.accusedName}</h3>
      {yodha.yodhaNumber && (
        <p className="text-sm font-semibold text-gray-500">Yodha #: {yodha.yodhaNumber}</p>
      )}
      <p className="text-sm text-gray-500">
        {[yodha.village, yodha.district, yodha.state].filter(Boolean).join(', ')}
      </p>
    </button>
  );

  // --- Render Function ---
  
  // --- NEW: PIN Lock Check ---
  if (!isAuthenticated) {
    return (
      <LoginScreen 
        pinInput={pinInput}
        setPinInput={setPinInput}
        pinError={pinError}
        onSubmit={handlePinSubmit}
      />
    );
  }
  
  // --- If Authenticated, render the app ---
  return (
    <div className="antialiased text-gray-800 font-inter min-h-screen bg-orange-50 p-4 md:p-8">
      
      {/* --- Edit Modal --- */}
      {editingYodha && (
        <Modal onClose={() => setEditingYodha(null)} size="md">
          <h2 className="text-2xl font-semibold text-gray-900 mb-6">
            Edit Yodha
          </h2>
          <YodhaForm
            initialData={editingYodha}
            onSubmit={handleUpdateSubmit}
            onCancel={() => setEditingYodha(null)}
            isEdit={true}
            districts={districts}
            onManageDistrictClick={() => setIsManagingDistricts(true)} 
            states={states}
            onManageStateClick={() => setIsManagingStates(true)} 
            categories={categories}
            onManageCategoryClick={() => setIsManagingCategories(true)} 
          />
        </Modal>
      )}

      {/* --- NEW Yodha Details Modal --- */}
      {viewingYodha && (
        <YodhaDetailsModal
          yodha={viewingYodha}
          onClose={() => setViewingYodha(null)}
          onEdit={() => {
            setEditingYodha(viewingYodha);
            setViewingYodha(null);
          }}
          onDelete={() => {
            setDeletingYodhaId(viewingYodha.id);
            setViewingYodha(null);
          }}
        />
      )}

      {/* --- Delete Confirmation Modal --- */}
      {deletingYodhaId && (
        <DeleteConfirmationModal
          onConfirm={handleConfirmDelete}
          onCancel={() => setDeletingYodhaId(null)}
        />
      )}
      
      {/* --- NEW Manage Modals --- */}
      {isManagingDistricts && (
        <ManageListModal
          title="Manage Districts"
          items={districts}
          placeholder="District"
          onConfirmAdd={(name) => handleAddItem('districts', name)}
          onConfirmDelete={(id) => handleDeleteItem('districts', id)}
          onCancel={() => setIsManagingDistricts(false)}
        />
      )}
      
      {isManagingStates && (
        <ManageListModal
          title="Manage States"
          items={states}
          placeholder="State"
          onConfirmAdd={(name) => handleAddItem('states', name)}
          onConfirmDelete={(id) => handleDeleteItem('states', id)}
          onCancel={() => setIsManagingStates(false)}
        />
      )}
      
      {isManagingCategories && (
        <ManageListModal
          title="Manage Categories"
          items={categories}
          placeholder="Category"
          onConfirmAdd={(name) => handleAddItem('categories', name)}
          onConfirmDelete={(id) => handleDeleteItem('categories', id)}
          onCancel={() => setIsManagingCategories(false)}
        />
      )}

      <div className="max-w-7xl mx-auto">
        <header className="mb-6">
          <h1 className="text-4xl md:text-5xl font-bold text-orange-700 text-center">
            Dharma Yodha Database
          </h1>
        </header>

        {/* --- Navigation Tabs --- */}
        <nav className="flex border-b border-orange-200 mb-8">
          <button
            onClick={() => setCurrentView('database')}
            className={`-mb-px px-6 py-3 text-lg font-medium leading-5 rounded-t-lg transition-colors duration-150 ease-in-out
              ${currentView === 'database' 
                ? 'border-b-2 border-orange-600 text-orange-600 focus:outline-none' 
                : 'text-gray-500 hover:text-orange-700 focus:outline-none'
              }`}
          >
            Database
          </button>
          <button
            onClick={() => setCurrentView('accounts')}
            className={`-mb-px px-6 py-3 text-lg font-medium leading-5 rounded-t-lg transition-colors duration-150 ease-in-out
              ${currentView === 'accounts' 
                ? 'border-b-2 border-orange-600 text-orange-600 focus:outline-none' 
                : 'text-gray-500 hover:text-orange-700 focus:outline-none'
              }`}
          >
            Accounts
          </button>
          {/* --- NEW ANALYSIS TAB --- */}
          <button
            onClick={() => setCurrentView('analysis')}
            className={`-mb-px px-6 py-3 text-lg font-medium leading-5 rounded-t-lg transition-colors duration-150 ease-in-out
              ${currentView === 'analysis' 
                ? 'border-b-2 border-orange-600 text-orange-600 focus:outline-none' 
                : 'text-gray-500 hover:text-orange-700 focus:outline-none'
              }`}
          >
            Analysis
          </button>
        </nav>

        {/* --- Conditional View Rendering --- */}

        {/* --- Database View --- */}
        {currentView === 'database' && (
          <>
            {/* Display Error Messages */}
            {error && (
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <span className="block sm:inline">{error}</span>
                <button 
                  onClick={() => setError('')} 
                  className="absolute top-0 bottom-0 right-0 px-4 py-3"
                >
                  <span className="text-xl">&times;</span>
                </button>
              </div>
            )}

            <div className="flex flex-col md:flex-row md:gap-8">
              
              {/* --- Input Form --- */}
              <div className="md:w-1/3 w-full mb-8 md:mb-0">
                <div className="bg-white p-6 rounded-xl shadow-lg">
                  <h2 className="text-2xl font-semibold text-gray-900 mb-6">
                    Add New Yodha
                  </h2>
                  <YodhaForm
                    initialData={initialFormData}
                    onSubmit={handleAddSubmit}
                    districts={districts}
                    onManageDistrictClick={() => setIsManagingDistricts(true)} 
                    states={states}
                    onManageStateClick={() => setIsManagingStates(true)} 
                    categories={categories}
                    onManageCategoryClick={() => setIsManagingCategories(true)} 
                  />
                </div>
              </div>

              {/* --- Display List --- */}
              <div className="md:w-2/3 w-full">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                  <h2 className="text-2xl font-semibold text-gray-900 mb-4 sm:mb-0">
                    Registered Yodhas
                  </h2>
                  
                  {/* --- Search Bar --- */}
                  <div className="relative w-full sm:w-auto">
                    <input
                      type="text"
                      placeholder="Search..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="pl-10 pr-4 py-2 w-full sm:w-64 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
                    />
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-gray-400">
                        <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                      </svg>
                    </div>
                  </div>
                </div>

                {/* --- NEW Breadcrumbs --- */}
                <Breadcrumbs />

                {isLoading && currentView === 'database' ? (
                  <div className="flex justify-center items-center h-48">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-700"></div>
                  </div>
                ) : yodhas.length === 0 ? (
                  <div className="bg-white text-center p-12 rounded-xl shadow-lg">
                    <p className="text-gray-500">No Yodhas have been added yet.</p>
                    <p className="text-gray-500">Use the form to add your first one.</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    
                    {/* --- Level 1: States --- */}
                    {navigationLevel === 'states' && (
                      statesWithCount.length > 0 ? (
                        statesWithCount.map(state => (
                          <NavigationCard
                            key={state.name}
                            title={state.name}
                            count={state.count}
                            onClick={() => handleStateClick(state.name)}
                          />
                        ))
                      ) : (
                        <div className="bg-white text-center p-12 rounded-xl shadow-lg">
                          <p className="text-gray-500">No states match your search query:</p>
                          <p className="text-gray-700 font-medium mt-2">"{searchQuery}"</p>
                        </div>
                      )
                    )}

                    {/* --- Level 2: Districts --- */}
                    {navigationLevel === 'districts' && (
                      districtsWithCount.length > 0 ? (
                        districtsWithCount.map(district => (
                          <NavigationCard
                            key={district.name}
                            title={district.name}
                            count={district.count}
                            onClick={() => handleDistrictClick(district.name)}
                          />
                        ))
                      ) : (
                        <div className="bg-white text-center p-12 rounded-xl shadow-lg">
                          <p className="text-gray-500">No districts match your search query:</p>
                          <p className="text-gray-700 font-medium mt-2">"{searchQuery}"</p>
                        </div>
                      )
                    )}

                    {/* --- Level 3: Yodhas --- */}
                    {navigationLevel === 'yodhas' && (
                      yodhasInDistrict.length > 0 ? (
                        yodhasInDistrict.map(yodha => (
                          <YodhaCard
                            key={yodha.id}
                            yodha={yodha}
                            onClick={() => setViewingYodha(yodha)}
                          />
                        ))
                      ) : (
                        <div className="bg-white text-center p-12 rounded-xl shadow-lg">
                          <p className="text-gray-500">No yodhas match your search query:</p>
                          <p className="text-gray-700 font-medium mt-2">"{searchQuery}"</p>
                        </div>
                      )
                    )}

                  </div>
                )}
              </div>
            </div>
          </>
        )}

        {/* --- Accounts View --- */}
        {currentView === 'accounts' && (
          <AccountsView 
            yodhas={yodhas} 
            transactions={transactions}
            onAddTransaction={handleAddTransaction}
            error={error}
            setError={setError}
          />
        )}

        {/* --- NEW ANALYSIS VIEW --- */}
        {currentView === 'analysis' && (
          <AnalysisView yodhas={yodhas} />
        )}

      </div>
    </div>
  );
}
